# 重复消费、顺序消费、分布式事务

## 消息队列的消息重复消费

- 消息**重复消费**是使用消息队列之后，必须要考虑的一个问题，也是较为 Problem solving 的问题，在开发过程中，但凡用到了消息队列，第一时间要考虑的就是**重复消费**的问题。
- 假设有这样一个场景，用户下单成功后，我需要去一个活动页面给他加**GMV**(销售总额)，最后根据他的GMV去给他发奖励，这是电商活动很常见的玩法。
- 类似下单金额到某个梯度，给你返回对应梯度的奖励
- 这样的活动百分百是用**异步**去加的，不然一个用户下一单就给他加一下，那就意味着对那张表就要操作一下，你考虑下双十一当天多少次对这个表操作？这数据库或者缓存都顶不住吧。
- 而且大家应该也有这样的体会，在你下单之后马上去看一些活动页面，有时候马上就有了，有时候却延迟很久，这个速度**取决于消息队列的消费速度**，消费堵塞了自然看到的就慢了。
- 你下个单**支付成功**你就发个消息出去，上面那个活动的开发人员就监听你的**支付成功消息**，那我就去我活动**GMV**表里给你加上去，到这里大家可能觉得顺理成章。

![](C:\Users\qzz\AppData\Roaming\Typora\typora-user-images\1597306121294.png)

- **但是**一般消息队列的使用都是有**重试机制**的，就是说下游的业务发生异常了，会输出异常并且要求你重发一次。

- 不过这个活动这里发生错误，要求重发肯定没问题，但是不止一个服务在监听这个消息，还有**别的服务也在监听**，那就会出现系统**本来是成功的，却重发了**。

  ![1597309031177](C:\Users\qzz\AppData\Roaming\Typora\typora-user-images\1597309031177.png)

- 就好比上面这样，优惠券系统处理失败了，这个系统肯定要求重发一次这个消息，